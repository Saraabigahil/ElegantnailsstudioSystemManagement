@page "/citas/agendar"
@layout MainLayout
@using ElegantnailsstudioSystemManagement.Models
@using ElegantnailsstudioSystemManagement.Services
@inject IServicioService ServicioService
@inject ICitaService CitaService
@inject ICupoService CupoService
@inject NavigationManager Navigation
@inject AuthService AuthService

@if (isLoading)
{
    <div class="loading-spinner">
        <div class="spinner-border spinner-custom" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
}
else
{
    <div class="citas-container">
        <div class="citas-header">
            <div class="container">
                <h1><i class="bi bi-calendar-plus"></i> Agendar Nueva Cita</h1>
                <p class="text-center text-muted-custom">Programa tu cita de belleza de forma rápida y sencilla</p>
            </div>
        </div>

        <div class="container fade-in">
            @if (AuthService.IsLoggedIn && AuthService.CurrentUser != null)
            {
                <div class="user-info-card">
                    <h5>
                        <i class="bi bi-person-check"></i> Información del Cliente
                    </h5>
                    <div class="row">
                        <div class="col-md-4">
                            <p><i class="bi bi-person me-2"></i><strong>Nombre:</strong> @AuthService.CurrentUser.Nombre</p>
                        </div>
                        <div class="col-md-4">
                            <p><i class="bi bi-envelope me-2"></i><strong>Email:</strong> @AuthService.CurrentUser.Email</p>
                        </div>
                        @if (!string.IsNullOrEmpty(AuthService.CurrentUser.telefono))
                        {
                            <div class="col-md-4">
                                <p><i class="bi bi-telephone me-2"></i><strong>Teléfono:</strong> @AuthService.CurrentUser.telefono</p>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger-custom alert-custom d-flex align-items-center mb-4">
                    <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                    <div>@mensajeError</div>
                </div>
            }

            <div class="main-card">
                <div class="card-header-custom">
                    <h3><i class="bi bi-scissors"></i> Detalles de la Cita</h3>
                </div>

                <div class="card-body p-4">
                    <div class="mb-4">
                        <label class="form-label-custom">1. Selecciona tu Servicio</label>

                        @if (servicioSeleccionado != null)
                        {
                            <div class="selected-service-card">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5><i class="bi bi-check-circle-fill me-2"></i>Servicio Seleccionado</h5>
                                    <button class="btn-change-service" @onclick="CambiarServicio">
                                        <i class="bi bi-arrow-repeat me-1"></i> Cambiar
                                    </button>
                                </div>

                                <h4 class="service-name">@servicioSeleccionado.Nombre</h4>
                                <p class="service-description">@servicioSeleccionado.Descripcion</p>

                                <div class="service-details">
                                    <div class="row">
                                        <div class="col-6">
                                            <span class="fw-bold text-white">
                                                <i class="bi bi-currency-dollar me-1"></i>
                                                Precio: @servicioSeleccionado.Precio.ToString("C")
                                            </span>
                                        </div>
                                        <div class="col-6 text-end">
                                            <span class="custom-badge">
                                                <i class="bi bi-clock me-1"></i>
                                                @servicioSeleccionado.DuracionMinutos minutos
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <select @onchange="OnServicioChange" class="form-select custom-select" value="@servicioId">
                                <option value="0">✨ Selecciona un servicio...</option>
                                @foreach (var servicio in servicios)
                                {
                                    <option value="@servicio.Id" selected="@(servicioId == servicio.Id)">
                                        @servicio.Nombre - @servicio.Precio.ToString("C") (@servicio.DuracionMinutos min)
                                    </option>
                                }
                            </select>
                        }
                    </div>

                    <div class="mb-4">
                        <label class="form-label-custom">2. Elige una Fecha</label>
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <input type="date"
                                       value="@fechaString"
                                       @onchange="OnFechaChange"
                                       class="form-control custom-date-input"
                                       min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="col-md-6 mt-2 mt-md-0">
                                <span class="text-muted-custom">
                                    <i class="bi bi-calendar-check me-2"></i>
                                    Fecha seleccionada: <strong>@fechaSeleccionada.ToString("dddd, dd MMMM yyyy", new System.Globalization.CultureInfo("es-ES"))</strong>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Sección de Turno -->
                    <div class="mb-4">
                        <label class="form-label-custom">3. Selecciona un Turno</label>
                        <div class="custom-radio-group">
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input custom-radio"
                                               type="radio"
                                               name="turno"
                                               id="manana"
                                               @onchange="@(() => OnTurnoChange("mañana"))"
                                               checked="@(turnoSeleccionado == "mañana")">
                                        <label class="form-check-label" for="manana">
                                            <i class="bi bi-sun-fill me-2 text-warning"></i>
                                            Mañana <br>
                                            <small class="text-muted-custom">8:00 AM - 12:00 PM</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input custom-radio"
                                               type="radio"
                                               name="turno"
                                               id="tarde"
                                               @onchange="@(() => OnTurnoChange("tarde"))"
                                               checked="@(turnoSeleccionado == "tarde")">
                                        <label class="form-check-label" for="tarde">
                                            <i class="bi bi-moon-stars-fill me-2 text-info"></i>
                                            Tarde <br>
                                            <small class="text-muted-custom">1:00 PM - 5:00 PM</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Verificación de disponibilidad -->
                    @if (mostrarVerificar)
                    {
                        <div class="mb-4 @(hayDisponibilidad ? "pulse" : "")">
                            <div class="alert @(hayDisponibilidad ? "alert-success-custom" : "alert-warning-custom") alert-custom d-flex align-items-center">
                                @if (hayDisponibilidad)
                                {
                                    <i class="bi bi-check-circle-fill me-3 fs-4"></i>
                                    <div>
                                        <h5 class="mb-1">¡Disponible!</h5>
                                        <p class="mb-0">Hay cupo para esta fecha y turno. ¡Puedes continuar!</p>
                                    </div>
                                }
                                else
                                {
                                    <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                                    <div>
                                        <h5 class="mb-1">Cupo no disponible</h5>
                                        <p class="mb-0">Por favor selecciona otra fecha u otro turno.</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Botón de agendar -->
                    <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top border-secondary">
                        <a href="/cliente" class="btn btn-secondary-custom btn-custom">
                            <i class="bi bi-arrow-left me-2"></i> Volver al Inicio
                        </a>

                        <button class="btn btn-primary-custom btn-custom @(hayDisponibilidad && servicioId != 0 ? "pulse" : "")"
                                @onclick="OnAgendarCita"
                                disabled="@(!hayDisponibilidad || servicioId == 0)">
                            <i class="bi bi-calendar-check me-2"></i>
                            Confirmar Cita
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Servicio> servicios = new();
    private Servicio servicioSeleccionado = null;
    private int servicioId = 0;
    private DateTime fechaSeleccionada = DateTime.Today;
    private string fechaString = "";
    private string turnoSeleccionado = "mañana";
    private bool hayDisponibilidad = false;
    private bool mostrarVerificar = false;
    private string mensajeError = "";
    private bool isLoading = true;

    [Parameter]
    [SupplyParameterFromQuery(Name = "servicioId")]
    public string ServicioIdQueryParam { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // VERIFICAR QUE EL USUARIO ESTÉ LOGUEADO
        if (!AuthService.IsLoggedIn)
        {
            Navigation.NavigateTo("/login?returnUrl=/citas/agendar");
            return;
        }

        await CargarServicios();
        fechaString = DateTime.Today.ToString("yyyy-MM-dd");

        if (!string.IsNullOrEmpty(ServicioIdQueryParam) && int.TryParse(ServicioIdQueryParam, out int id))
        {
            servicioId = id;
            await SetServicioSeleccionado(id);
        }

        isLoading = false;
    }

    private async Task CargarServicios()
    {
        servicios = await ServicioService.GetServiciosActivosAsync();
    }

    private async Task SetServicioSeleccionado(int id)
    {
        servicioId = id;
        servicioSeleccionado = servicios.FirstOrDefault(s => s.Id == id);
        if (servicioSeleccionado != null)
        {
            await VerificarDisponibilidad();
        }
        StateHasChanged();
    }

    private async Task OnServicioChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            await SetServicioSeleccionado(id);
        }
    }

    private void CambiarServicio()
    {
        servicioSeleccionado = null;
        servicioId = 0;
        hayDisponibilidad = false;
        mostrarVerificar = false;
        Navigation.NavigateTo("/citas/agendar", replace: true);
    }

    private async Task OnFechaChange(ChangeEventArgs e)
    {
        fechaString = e.Value?.ToString() ?? DateTime.Today.ToString("yyyy-MM-dd");
        if (DateTime.TryParse(fechaString, out var fecha))
        {
            fechaSeleccionada = fecha;
            await VerificarDisponibilidad();
        }
    }

    private async Task OnTurnoChange(string turno)
    {
        turnoSeleccionado = turno;
        await VerificarDisponibilidad();
    }

    private async Task VerificarDisponibilidad()
    {
        if (servicioId == 0)
        {
            mostrarVerificar = false;
            return;
        }

        var servicio = servicios.FirstOrDefault(s => s.Id == servicioId);
        if (servicio == null)
        {
            mostrarVerificar = false;
            return;
        }

        try
        {
            hayDisponibilidad = await CupoService.CheckDisponibilidadAsync(
                fechaSeleccionada,
                turnoSeleccionado,
                servicio.DuracionMinutos
            );

            mostrarVerificar = true;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al verificar disponibilidad: {ex.Message}";
            hayDisponibilidad = false;
            mostrarVerificar = true;
        }

        StateHasChanged();
    }

    private async Task OnAgendarCita()
    {
        // VERIFICAR QUE EL USUARIO ESTÉ LOGUEADO
        if (!AuthService.IsLoggedIn || AuthService.CurrentUser == null)
        {
            Navigation.NavigateTo("/login?returnUrl=/citas/agendar");
            return;
        }

        if (servicioId == 0)
        {
            mensajeError = "Debes seleccionar un servicio primero";
            return;
        }

        await VerificarDisponibilidad();

        if (!hayDisponibilidad)
        {
            mensajeError = "No hay cupo disponible. Por favor selecciona otra fecha u otro turno.";
            return;
        }

        // USAR EL ID DEL USUARIO LOGUEADO
        var nuevaCita = new Cita
            {
                ClienteId = AuthService.CurrentUser.Id, 
                ServicioId = servicioId,
                FechaCita = fechaSeleccionada,
                Turno = turnoSeleccionado,
                Estado = "pendiente",
                FechaCreacion = DateTime.Now
            };

        var exito = await CitaService.CreateCitaAsync(nuevaCita);

        if (exito)
        {
            Navigation.NavigateTo("/citas/mis-citas");
        }
        else
        {
            mensajeError = "No se pudo agendar la cita. Por favor intenta nuevamente.";
        }
    }
}