@page "/citas/agendar"
@layout MainLayout
@using ElegantnailsstudioSystemManagement.Models
@using ElegantnailsstudioSystemManagement.Services
@inject IServicioService ServicioService
@inject ICitaService CitaService
@inject ICupoService CupoService
@inject NavigationManager Navigation

<PageTitle>Agendar Cita</PageTitle>

<div class="container mt-4">
    <h1>Agendar Nueva Cita</h1>

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger">@mensajeError</div>
    }

    <div class="card">
        <div class="card-body">
            <!-- SERVICIO SELECCIONADO (si viene de un card) -->
            @if (servicioSeleccionado != null)
            {
                <div class="alert alert-info mb-4">
                    <h5>Servicio seleccionado:</h5>
                    <p><strong>@servicioSeleccionado.Nombre</strong></p>
                    <p>@servicioSeleccionado.Descripcion</p>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Precio: @servicioSeleccionado.Precio.ToString("C")</span>
                        <span class="badge bg-primary">
                            <i class="bi bi-clock me-1"></i>@servicioSeleccionado.DuracionMinutos min
                        </span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" @onclick="CambiarServicio">
                        <i class="bi bi-arrow-repeat me-1"></i>Cambiar servicio
                    </button>
                </div>
            }
            else
            {
                <!-- COMBOBOX SOLO SI NO VIENE CON SERVICIO -->
                <div class="mb-3">
                    <label class="form-label">Servicio</label>
                    <select @onchange="OnServicioChange" class="form-select" value="@servicioId">
                        <option value="0">Seleccione un servicio</option>
                        @foreach (var servicio in servicios)
                        {
                            <option value="@servicio.Id" selected="@(servicioId == servicio.Id)">
                                @servicio.Nombre - @servicio.Precio.ToString("C")
                            </option>
                        }
                    </select>
                </div>
            }

            <div class="mb-3">
                <label class="form-label">Fecha</label>
                <input type="date" value="@fechaString"
                       @onchange="OnFechaChange"
                       class="form-control"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                <small class="text-muted">Fecha seleccionada: @fechaSeleccionada.ToString("dd/MM/yyyy")</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Turno</label>
                <div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                               name="turno" id="manana"
                               @onchange="@(() => OnTurnoChange("mañana"))"
                               checked="@(turnoSeleccionado == "mañana")">
                        <label class="form-check-label" for="manana">
                            Mañana (8:00 AM - 12:00 PM)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                               name="turno" id="tarde"
                               @onchange="@(() => OnTurnoChange("tarde"))"
                               checked="@(turnoSeleccionado == "tarde")">
                        <label class="form-check-label" for="tarde">
                            Tarde (1:00 PM - 5:00 PM)
                        </label>
                    </div>
                </div>
            </div>

            @if (mostrarVerificar)
            {
                <div class="alert @(hayDisponibilidad ? "alert-success" : "alert-warning")">
                    @if (hayDisponibilidad)
                    {
                        <span>✅ Hay cupo disponible para esta fecha y turno</span>
                    }
                    else
                    {
                        <span>❌ No hay cupo disponible. Por favor seleccione otra fecha u otro turno.</span>
                    }
                </div>
            }

            <button class="btn btn-primary" @onclick="OnAgendarCita"
                    disabled="@(!hayDisponibilidad || servicioId == 0)">
                Agendar Cita
            </button>
        </div>

        <div class="mt-3">
            <a href="/cliente" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Atrás
            </a>
        </div>
    </div>
</div>

@code {
    private List<Servicio> servicios = new();
    private Servicio servicioSeleccionado = null;
    private int servicioId = 0;
    private DateTime fechaSeleccionada = DateTime.Today;
    private string fechaString = "";
    private string turnoSeleccionado = "mañana";
    private bool hayDisponibilidad = false;
    private bool mostrarVerificar = false;
    private string mensajeError = "";

    // Cambia esto para usar SupplyParameterFromQuery correctamente
    [Parameter]
    [SupplyParameterFromQuery(Name = "servicioId")]
    public string ServicioIdQueryParam { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await CargarServicios();
        fechaString = DateTime.Today.ToString("yyyy-MM-dd");

        // CAPTURAR EL SERVICIOID DE LA URL SI EXISTE
        if (!string.IsNullOrEmpty(ServicioIdQueryParam) && int.TryParse(ServicioIdQueryParam, out int id))
        {
            servicioId = id;
            await SetServicioSeleccionado(id);
        }
    }

    private async Task CargarServicios()
    {
        servicios = await ServicioService.GetServiciosActivosAsync();
    }

    private async Task SetServicioSeleccionado(int id)
    {
        servicioId = id;
        servicioSeleccionado = servicios.FirstOrDefault(s => s.Id == id);
        if (servicioSeleccionado != null)
        {
            await VerificarDisponibilidad();
        }
    }

    private async Task OnServicioChange(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            await SetServicioSeleccionado(id);
        }
    }

    // MÉTODO PARA CAMBIAR DE SERVICIO
    private void CambiarServicio()
    {
        servicioSeleccionado = null;
        servicioId = 0;
        hayDisponibilidad = false;
        mostrarVerificar = false;
        Navigation.NavigateTo("/citas/agendar", replace: true);
    }

    private async Task OnFechaChange(ChangeEventArgs e)
    {
        fechaString = e.Value?.ToString() ?? DateTime.Today.ToString("yyyy-MM-dd");
        if (DateTime.TryParse(fechaString, out var fecha))
        {
            fechaSeleccionada = fecha;
            await VerificarDisponibilidad();
        }
    }

    private async Task OnTurnoChange(string turno)
    {
        turnoSeleccionado = turno;
        await VerificarDisponibilidad();
    }

    private async Task VerificarDisponibilidad()
    {
        if (servicioId == 0)
        {
            mostrarVerificar = false;
            return;
        }

        var servicio = servicios.FirstOrDefault(s => s.Id == servicioId);
        if (servicio == null)
        {
            mostrarVerificar = false;
            return;
        }

        try
        {
            hayDisponibilidad = await CupoService.CheckDisponibilidadAsync(
                fechaSeleccionada,
                turnoSeleccionado,
                servicio.DuracionMinutos
            );

            mostrarVerificar = true;
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al verificar disponibilidad: {ex.Message}";
            hayDisponibilidad = false;
            mostrarVerificar = true;
        }

        StateHasChanged();
    }

    private async Task OnAgendarCita()
    {
        if (servicioId == 0)
        {
            mensajeError = "Seleccione un servicio";
            return;
        }

        await VerificarDisponibilidad();

        if (!hayDisponibilidad)
        {
            mensajeError = "No hay cupo disponible. Por favor seleccione otra fecha u otro turno.";
            return;
        }

        var nuevaCita = new Cita
            {
                ClienteId = 2, // Cambia esto por el ID del cliente logueado
                ServicioId = servicioId,
                FechaCita = fechaSeleccionada,
                Turno = turnoSeleccionado,
                Estado = "pendiente",
                FechaCreacion = DateTime.Now
            };

        var exito = await CitaService.CreateCitaAsync(nuevaCita);

        if (exito)
        {
            Navigation.NavigateTo("/citas/mis-citas");
        }
        else
        {
            mensajeError = "No se pudo agendar la cita. Verifique la disponibilidad.";
        }
    }
}






