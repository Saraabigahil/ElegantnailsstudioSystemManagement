@page "/admin/citas"

@inject ICitaService CitaService
@inject IServicioService ServicioService
@inject NavigationManager Navigation

<PageTitle>Citas - Panel de Administración</PageTitle>

<div class="admin-citas-container">
    <!-- Contenedor flexible: botón + header -->
    <div class="admin-header-container">
        <!-- Botón para volver al admin -->
        <a href="/admin" class="btn btn-volver-icono" title="Volver al Panel">
            <i class="bi bi-arrow-left-circle fs-4"></i>
        </a>

        <!-- Header que ocupa el ancho restante -->
        <div class="admin-citas-header">
            <div class="header-content">
                <h1><i class="bi bi-calendar-check me-2"></i>Citas de Clientes</h1>
                <div class="subtitle">
                    <i class="bi bi-funnel me-1"></i> Administra y supervisa todas las citas programadas
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger admin-citas-alert">
            <i class="bi bi-exclamation-triangle me-2"></i> @mensajeError
        </div>
    }
    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success admin-citas-alert">
            <i class="bi bi-check-circle me-2"></i> @mensajeExito
        </div>
    }

    @if (citas == null)
    {
        <div class="text-center p-5">
            <div class="spinner-border admin-citas-spinner" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3" style="color: #e83e8c">Cargando citas...</p>
        </div>
    }
    else if (!citas.Any())
    {
        <div class="no-data-message">
            <i class="bi bi-calendar-x no-data-icon"></i>
            <h3>No hay citas registradas</h3>
            <p>No se han encontrado citas en el sistema.</p>
        </div>
    }
    else
    {
        <div class="admin-citas-table-container">
            <table class="table admin-citas-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Servicio</th>
                        <th>Fecha</th>
                        <th>Turno</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cita in citas)
                    {
                        var servicio = servicios.FirstOrDefault(s => s.Id == cita.ServicioId);

                        <tr>
                            <td class="cita-id">#@cita.Id</td>

                            <td class="cliente-id">
                                @if (cita.Cliente != null)
                                {
                                    <strong>@cita.Cliente.Nombre</strong>
                                    <br />
                                    <small class="text-muted">@cita.Cliente.Email</small>
                                    <br />
                                    <small class="text-muted">
                                        <i class="bi bi-telephone me-1"></i>
                                        @cita.Cliente.telefono
                                    </small>
                                }
                                else
                                {
                                    <span class="text-muted">Cliente no disponible</span>
                                }
                            </td>


                            <td>
                                <div class="servicio-info">
                                    @if (servicio != null)
                                    {
                                        <div class="servicio-nombre">@servicio.Nombre</div>
                                        <div class="servicio-precio">@servicio.Precio.ToString("C")</div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Servicio #@cita.ServicioId</span>
                                    }
                                </div>
                            </td>
                            <td>
                                <div class="fecha-info">
                                    <div class="fecha-cita">@cita.FechaCita.ToString("dd/MM/yyyy")</div>
                                    <div class="hora-cita">@cita.FechaCreacion.ToString("HH:mm")</div>
                                </div>
                            </td>
                            <td>
                                @{
                                    var turnoClass = cita.Turno.ToLower() switch
                                    {
                                        "mañana" => "badge-turno badge-mañana",
                                        "tarde" => "badge-turno badge-tarde",
                                        "noche" => "badge-turno badge-noche",
                                        _ => "badge-turno badge-mañana"
                                    };
                                }
                                <span class="@turnoClass">
                                    @cita.Turno
                                </span>
                            </td>
                            <td>
                                @{
                                    var estadoClass = cita.Estado.ToLower() switch
                                    {
                                        "pendiente" => "badge-estado badge-pendiente",
                                        "completada" => "badge-estado badge-completada",
                                        "cancelada" => "badge-estado badge-cancelada",
                                        _ => "badge-estado badge-pendiente"
                                    };
                                }
                                <span class="@estadoClass">
                                    @if (cita.Estado == "pendiente")
                                    {
                                        <text>PENDIENTE</text>
                                    }
                                    else if (cita.Estado == "completada")
                                    {
                                        <text>COMPLETADA</text>
                                    }
                                    else
                                    {
                                        <text>CANCELADA</text>
                                    }
                                </span>
                            </td>
                            <td>
                                @if (cita.Estado == "pendiente")
                                {
                                    <div class="acciones-container">
                                        <button class="btn btn-accion btn-completar me-1"
                                                @onclick="@(() => CompletarCita(cita.Id))">
                                            <i class="bi bi-check"></i> Completar
                                        </button>
                                        <button class="btn btn-accion btn-cancelar"
                                                @onclick="@(() => CancelarCita(cita.Id))">
                                            <i class="bi bi-x"></i> Cancelar
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <span class="text-muted">
                                        <i class="bi bi-lock me-1"></i>No disponible
                                    </span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Cita> citas = new();
    private List<Servicio> servicios = new();
    private string? mensajeError;
    private string? mensajeExito;

    protected override async Task OnInitializedAsync()
    {
        await CargarCitas();
    }

    private async Task CargarCitas()
    {
        try
        {
            servicios = await ServicioService.GetServiciosActivosAsync();
            citas = await CitaService.GetCitasAsync();
            citas = citas.OrderByDescending(c => c.FechaCita).ThenBy(c => c.Turno).ToList();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error al cargar citas: {ex.Message}";
        }
    }

    private async Task CompletarCita(int id)
    {
        if (await CitaService.CompletarCitaAsync(id))
        {
            mensajeExito = "Cita marcada como completada";
            await CargarCitas();
        }
        else
        {
            mensajeError = "Error al completar la cita";
        }
    }

    private async Task CancelarCita(int id)
    {
        if (await CitaService.CancelarCitaAdminAsync(id))
        {
            mensajeExito = "Cita cancelada";
            await CargarCitas();
        }
        else
        {
            mensajeError = "Error al cancelar la cita";
        }
    }
}