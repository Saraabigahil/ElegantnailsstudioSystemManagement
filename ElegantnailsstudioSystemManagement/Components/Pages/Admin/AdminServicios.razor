@page "/admin/servicios"
@using ElegantnailsstudioSystemManagement.Models
@using ElegantnailsstudioSystemManagement.Services
@inject IServicioService ServicioService
@inject ICategoriaService CategoriaService
@inject IWebHostEnvironment Env
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

<PageTitle>Gestión de Servicios</PageTitle>

<div class="admin-servicios-container">
    <div class="d-flex justify-content-between align-items-center servicios-header">
        <h3><i class="bi bi-scissors me-2"></i>Gestión de Servicios</h3>
        <button class="btn btn-new-service" @onclick="AbrirNuevo">
            <i class="bi bi-plus-circle me-2"></i>Nuevo Servicio
        </button>
    </div>

    @if (!string.IsNullOrEmpty(mensajeExito))
    {
        <div class="alert alert-success">@mensajeExito</div>
    }

    @if (!string.IsNullOrEmpty(mensajeError))
    {
        <div class="alert alert-danger">@mensajeError</div>
    }

    @if (servicios.Any())
    {
        <div class="services-grid">
            @foreach (var s in servicios)
            {
                <div class="service-card">
                    <img src="@(!string.IsNullOrEmpty(s.ImagenUrl) ? s.ImagenUrl : "/placeholder-image.png")"
                         onerror="this.src='/placeholder-image.png'" />

                    <div class="card-body">
                        <h5>@s.Nombre</h5>
                        <p>@(s.Categoria?.Nombre ?? "Sin categoría")</p>
                        <p>$ @s.Precio.ToString("0.00")</p>

                        <button class="btn btn-sm btn-primary" @onclick="() => Editar(s)">Editar</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => MostrarModalEliminar(s)">Eliminar</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- MODAL SERVICIO -->
@if (mostrarModal)
{
    <div class="modal show d-block">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>@(servicio.Id == 0 ? "Nuevo Servicio" : "Editar Servicio")</h5>
                    <button class="btn-close" @onclick="CerrarModalHandler"></button>
                </div>

                <!-- FORMULARIO PARA SERVICIO -->
                <form method="post" onsubmit="return false;">
                    <div class="modal-body">
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre *</label>
                            <input type="text" class="form-control"
                                   @bind="servicio.Nombre"
                                   @bind:event="oninput"
                                   required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" rows="3"
                                      @bind="servicio.Descripcion"
                                      @bind:event="oninput"></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Precio *</label>
                                <input type="number" class="form-control"
                                       step="0.01"
                                       @bind="servicio.Precio"
                                       @bind:event="oninput"
                                       required />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Duración (minutos) *</label>
                                <input type="number" class="form-control"
                                       @bind="servicio.DuracionMinutos"
                                       @bind:event="oninput"
                                       required />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Categoría *</label>
                            <select class="form-select" @bind="servicio.CategoriaId">
                                <option value="0">Seleccione categoría</option>
                                @foreach (var c in categorias)
                                {
                                    <option value="@c.Id">@c.Nombre</option>
                                }
                            </select>
                        </div>

                        <!-- SECCIÓN DE IMAGEN -->
                        <div class="mb-3">
                            <label class="form-label">Imagen del Servicio</label>

                            @if (!string.IsNullOrEmpty(servicio.ImagenUrl) && !servicio.ImagenUrl.Contains("placeholder"))
                            {
                                <div class="text-center mb-2">
                                    <img src="@servicio.ImagenUrl"
                                         class="img-fluid rounded"
                                         style="max-height: 200px;"
                                         onerror="this.src='/placeholder-image.png'" />
                                </div>
                            }
                            else
                            {
                                <div class="text-center mb-2">
                                    <img src="/placeholder-image.png"
                                         class="img-fluid rounded"
                                         style="max-height: 200px;" />
                                </div>
                            }

                            <!-- FORMULARIO PARA SUBIR IMAGEN -->
                            @if (servicio.Id > 0)
                            {
                                <div class="border p-3 rounded bg-light">
                                    <h6 class="mb-3">Subir nueva imagen</h6>
                                    <form method="post" enctype="multipart/form-data"
                                          action="/uploadservicio">
                                        <input type="hidden" name="servicioId" value="@servicio.Id" />
                                        <div class="input-group">
                                            <input type="file" name="file"
                                                   class="form-control"
                                                   accept=".jpg,.jpeg,.png,.gif,.webp"
                                                   required />
                                            <button type="submit" class="btn btn-primary">
                                                <i class="bi bi-upload me-1"></i>Subir
                                            </button>
                                        </div>
                                        <small class="text-muted">Formatos permitidos: JPG, PNG, GIF, WEBP (Máx. 5MB)</small>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Primero guarde el servicio para poder subir una imagen.
                                </div>
                            }
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-success"
                                @onclick="GuardarServicioAsync"
                                disabled="@isGuardando">
                            @if (isGuardando)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Servicio</span>
                            }
                        </button>
                        <button type="button" class="btn btn-secondary"
                                @onclick="CerrarModalHandler"
                                disabled="@isGuardando">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@if (mostrarModalEliminar && servicioAEliminar != null)
{
    <div class="modal show d-block">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <p>¿Eliminar <strong>@servicioAEliminar.Nombre</strong>?</p>
                    <button class="btn btn-danger" @onclick="ConfirmarEliminacionAsync">Sí</button>
                    <button class="btn btn-secondary" @onclick="CancelarEliminacion">No</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    List<Servicio> servicios = new();
    List<Categoria> categorias = new();
    Servicio servicio = new();
    Servicio? servicioAEliminar;
    bool mostrarModal;
    bool mostrarModalEliminar;
    bool isGuardando = false;
    string mensajeExito = "";
    string mensajeError = "";

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosAsync();
        await ProcesarParametrosUrl();
    }

    private async Task ProcesarParametrosUrl()
    {
        try
        {
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            if (uri.Query.Contains("img="))
            {
                var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
                var imgUrl = query["img"];
                var servicioIdStr = query["servicioId"];

                if (!string.IsNullOrEmpty(imgUrl) && !string.IsNullOrEmpty(servicioIdStr)
                    && int.TryParse(servicioIdStr, out int servicioId))
                {
                    if (servicioId > 0)
                    {
                        // Busca el servicio y abre modal de edición
                        var serv = await ServicioService.GetServicioByIdAsync(servicioId);
                        if (serv != null)
                        {
                            servicio = new Servicio
                                {
                                    Id = serv.Id,
                                    Nombre = serv.Nombre,
                                    Descripcion = serv.Descripcion,
                                    Precio = serv.Precio,
                                    DuracionMinutos = serv.DuracionMinutos,
                                    CategoriaId = serv.CategoriaId,
                                    ImagenUrl = imgUrl 
                                };
                            mostrarModal = true;
                            mensajeExito = "Imagen actualizada correctamente";

                            // Limpia URL
                            NavigationManager.NavigateTo("/admin/servicios", replace: true);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error procesando imagen: {ex.Message}";
        }
    }

    private async Task CargarDatosAsync()
    {
        servicios = await ServicioService.GetServiciosActivosAsync();
        categorias = await CategoriaService.GetCategoriasAsync();
        StateHasChanged();
    }

    void AbrirNuevo()
    {
        servicio = new Servicio();
        mostrarModal = true;
        mensajeError = mensajeExito = "";
    }

    void Editar(Servicio s)
    {
        servicio = new Servicio
            {
                Id = s.Id,
                Nombre = s.Nombre,
                Descripcion = s.Descripcion,
                Precio = s.Precio,
                DuracionMinutos = s.DuracionMinutos,
                CategoriaId = s.CategoriaId,
                ImagenUrl = s.ImagenUrl
            };
        mostrarModal = true;
        mensajeError = mensajeExito = "";
    }

    private async Task GuardarServicioAsync()
    {
        try
        {
            isGuardando = true;
            mensajeError = mensajeExito = "";

            // Validaciones
            if (string.IsNullOrWhiteSpace(servicio.Nombre))
            {
                mensajeError = "El nombre es requerido";
                isGuardando = false;
                return;
            }

            if (servicio.CategoriaId == 0)
            {
                mensajeError = "Debe seleccionar una categoría";
                isGuardando = false;
                return;
            }

            bool ok = servicio.Id == 0
                ? await ServicioService.CrearServicio(servicio)
                : await ServicioService.ActualizarServicio(servicio);

            if (ok)
            {
                if (servicio.Id == 0)
                {
                    var nuevosServicios = await ServicioService.GetServiciosActivosAsync();
                    var nuevoServicio = nuevosServicios.FirstOrDefault(s => s.Nombre == servicio.Nombre);
                    if (nuevoServicio != null)
                    {
                        servicio.Id = nuevoServicio.Id;
                    }
                }

                mensajeExito = "Servicio guardado correctamente";

                if (servicio.Id == 0)
                {
                    mensajeExito += ". Ahora puede subir una imagen para el servicio.";
                }
                else
                {
                    await CargarDatosAsync();
                }

                StateHasChanged();
            }
            else
            {
                mensajeError = "Error al guardar servicio";
            }
        }
        catch (Exception ex)
        {
            mensajeError = $"Error: {ex.Message}";
        }
        finally
        {
            isGuardando = false;
            StateHasChanged();
        }
    }

    private async Task CerrarModalHandler()
    {
        await CerrarModal();
    }

    //cerrar modal
    private async Task CerrarModal()
    {
        mostrarModal = false;
        servicio = new Servicio();
        await CargarDatosAsync();
    }

    void MostrarModalEliminar(Servicio s)
    {
        servicioAEliminar = s;
        mostrarModalEliminar = true;
    }

    private async Task ConfirmarEliminacionAsync()
    {
        if (servicioAEliminar != null)
        {
            await ServicioService.EliminarServicioAsync(servicioAEliminar.Id);
            await CargarDatosAsync();
        }
        mostrarModalEliminar = false;
    }

    void CancelarEliminacion() => mostrarModalEliminar = false;
}