@page "/admin/categorias/agregar"
@using ElegantnailsstudioSystemManagement.Models
@inject ICategoriaService CategoriaService

<PageTitle>Crear Categoría - Elegant Nails</PageTitle>

<div class="admin-agregar-categoria-container">
    <div class="agregar-categoria-header">
        <i class="bi bi-plus-circle-fill header-icon"></i>
        <h1>CREAR NUEVA CATEGORÍA</h1>
    </div>

    <EditForm Model="nuevaCategoria" OnValidSubmit="Guardar">
        <div class="categoria-form-container">
            <div class="form-group-custom">
                <label class="form-label-custom">
                    <i class="bi bi-tag"></i>Nombre de la Categoría
                </label>
                <InputText @bind-Value="nuevaCategoria.Nombre"
                           class="input-categoria-nombre"
                           placeholder="Ej: Pestañas, Uñas, Maquillaje..." />
            </div>

            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="mensaje-container">
                    <div class="@(error ? "mensaje-error" : "mensaje-exito")">
                        <i class="bi @(error ? "bi-exclamation-circle" : "bi-check-circle")"></i>
                        <span>@mensaje</span>
                    </div>
                </div>
            }

            <button type="submit" class="btn-guardar-categoria">
                <i class="bi bi-save"></i>
                <span>Guardar Categoría</span>
            </button>
        </div>
    </EditForm>

    <div class="btn-atras-container">
        <a href="/admin/categorias" class="btn btn-atras">
            <i class="bi bi-arrow-left"></i>
            <span>Volver a Categorías</span>
        </a>
    </div>

    <div class="categorias-existente-container">
        <h3 class="categorias-existente-titulo">
            <i class="bi bi-list-check"></i>
            <span>Categorías existentes</span>
        </h3>

        @if (categorias.Any())
        {
            <ul class="lista-categorias">
                @foreach (var cat in categorias.OrderByDescending(c => c.Id))
                {
                    <li class="categoria-item">
                        <span class="categoria-id">@cat.Id</span>
                        <span class="categoria-nombre">@cat.Nombre</span>
                    </li>
                }
            </ul>
        }
        else
        {
            <div class="text-center py-4">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">No hay categorías registradas aún</p>
            </div>
        }
    </div>
</div>

@code {
    private Categoria nuevaCategoria = new Categoria();
    private string mensaje = "";
    private bool error = false;
    private List<Categoria> categorias = new();

    protected override async Task OnInitializedAsync()
    {
        await CargarCategorias();
    }

    private async Task CargarCategorias()
    {
        categorias = await CategoriaService.GetCategoriasAsync();
    }

    private async Task Guardar()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(nuevaCategoria.Nombre))
            {
                mensaje = "Por favor, ingresa un nombre para la categoría";
                error = true;
                return;
            }

            var guardado = await CategoriaService.CreateCategoriaAsync(nuevaCategoria);

            if (guardado)
            {
                mensaje = "¡Categoría guardada correctamente!";
                error = false;

                nuevaCategoria = new Categoria();
                await CargarCategorias();

                await Task.Delay(3000);
                mensaje = "";
            }
            else
            {
                mensaje = "La categoría ya existe o no se pudo guardar.";
                error = true;
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            error = true;
        }
    }
}