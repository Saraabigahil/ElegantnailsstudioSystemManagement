@page "/registro"
@using ElegantnailsstudioSystemManagement.Models
@using ElegantnailsstudioSystemManagement.Services
@inject NavigationManager Navigation
@inject IUsuarioService UsuarioService

<PageTitle>Crear Cuenta - Elegant Nails</PageTitle>

<div class="registro-page">
    
    <div class="registro-container">
        <div class="registro-lado-imagen">
            <div class="registro-imagen-overlay"></div>
            <div class="registro-contenido-imagen">
                <h1 class="registro-titulo-imagen">Elegant Nails</h1>
                <p class="registro-descripcion">
                    Transforma tu estilo con nuestros servicios exclusivos.
                    La perfección en cada detalle para realzar tu belleza natural.
                </p>
            </div>
        </div>

        <div class="registro-lado-formulario">
            <div class="registro-form-content">
                <div class="registro-header">
                    <h2 class="registro-titulo">Crear Cuenta Nueva</h2>
                    <p class="registro-subtitulo">Completa tus datos para comenzar</p>
                </div>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="alert alert-danger alert-registro">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        @ErrorMessage
                        <button type="button" class="btn-close" @onclick="ClearError"></button>
                    </div>
                }

                @if (!string.IsNullOrEmpty(SuccessMessage))
                {
                    <div class="alert alert-success alert-registro">
                        <i class="bi bi-check-circle me-2"></i>
                        @SuccessMessage
                        <button type="button" class="btn-close" @onclick="ClearSuccess"></button>
                    </div>
                }

                <div class="registro-form">
                    <div class="form-group">
                        <label class="form-label">
                            Nombre completo <span class="text-danger">*</span>:
                        </label>
                        <input type="text"
                               @bind="nombre"
                               @bind:event="oninput"
                               class="form-control"
                               placeholder="Tu nombre completo" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Email <span class="text-danger">*</span>:
                        </label>
                        <input type="email"
                               @bind="email"
                               @bind:event="oninput"
                               class="form-control"
                               placeholder="email@ejemplo.com" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Contraseña <span class="text-danger">*</span>:
                        </label>
                        <input type="password"
                               @bind="password"
                               @bind:event="oninput"
                               class="form-control"
                               placeholder="Mínimo 6 caracteres" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            Teléfono (opcional):
                        </label>
                        <input type="text"
                               @bind="telefono"
                               @bind:event="oninput"
                               class="form-control"
                               placeholder="(123) 456-7890" />
                    </div>

                    <button type="button"
                            class="btn-registro-principal"
                            @onclick="GuardarUsuarioClick"
                            disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            <span>Creando cuenta...</span>
                        }
                        else
                        {
                            <i class="bi bi-person-plus me-2"></i>
                            <span>Crear Cuenta</span>
                        }
                    </button>

                    <hr class="registro-separador" />

                    <a href="/" class="btn-registro-secundario">
                        <i class="bi bi-arrow-left me-2"></i>Volver
                    </a>
                </div>

                <div class="text-center mt-4">
                    <a href="/login" class="btn-volver-link">
                        <i class="bi bi-arrow-left me-1"></i>
                        ¿Ya tienes una cuenta? Inicia sesión aquí
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {

    private string nombre = "";
    private string email = "";
    private string password = "";
    private string telefono = "";

    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private bool isLoading = false;
    private List<Usuario> usuariosExistente = new();

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("🔍 Registro.razor inicializado");
        await CargarUsuarios();
    }

    private async Task CargarUsuarios()
    {
        try
        {
            usuariosExistente = await UsuarioService.GetUsuariosAsync();
            Console.WriteLine($"✅ Usuarios cargados: {usuariosExistente.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"❌ Error cargando usuarios: {ex.Message}");
            usuariosExistente = new List<Usuario>();
        }
    }


    private void ProbarConDatos()
    {
        Console.WriteLine("🧪 Probando con datos de prueba...");

        nombre = "Usuario de Prueba";
        email = $"prueba{new Random().Next(1000, 9999)}@test.com";
        password = "123456";
        telefono = "1234567890";

        Console.WriteLine($"📋 Datos cargados: {email}");
        StateHasChanged();
    }


    private async Task GuardarUsuarioClick()
    {
        Console.WriteLine("\n=== 🚀 GUARDARUSUARIOCLICK INICIADO ===");
        await ProcesarGuardado();
    }


    private async Task ProcesarGuardado()
    {
        Console.WriteLine("\n=== 🚀 PROCESARGUARDADO INICIADO ===");
        Console.WriteLine($"📝 Datos del formulario:");
        Console.WriteLine($"   Nombre: '{nombre}'");
        Console.WriteLine($"   Email: '{email}'");
        Console.WriteLine($"   Password: '{password}' (length: {password?.Length})");
        Console.WriteLine($"   Teléfono: '{telefono}'");


        if (string.IsNullOrWhiteSpace(nombre))
        {
            Console.WriteLine("❌ Validación falló: Nombre vacío");
            ErrorMessage = "El nombre es requerido";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(email) || !email.Contains("@"))
        {
            Console.WriteLine("❌ Validación falló: Email inválido");
            ErrorMessage = "Email inválido";
            StateHasChanged();
            return;
        }

        if (string.IsNullOrWhiteSpace(password) || password.Length < 6)
        {
            Console.WriteLine($"❌ Validación falló: Password inválido (length: {password?.Length})");
            ErrorMessage = "La contraseña debe tener al menos 6 caracteres";
            StateHasChanged();
            return;
        }


        var nuevoUsuario = new Usuario
            {
                Nombre = nombre,
                Email = email,
                Password = password,
                telefono = telefono,
                rolid = 2
            };

        Console.WriteLine($"👤 Usuario creado para guardar - RolId: {nuevoUsuario.rolid}");


        isLoading = true;
        ErrorMessage = "";
        SuccessMessage = "";
        StateHasChanged();

        await Task.Delay(300);

        try
        {
            Console.WriteLine("📞 Llamando a UsuarioService.CreateUsuarioAsync...");
            Console.WriteLine($"📧 Email a guardar: '{nuevoUsuario.Email}'");
            Console.WriteLine($"🔑 Password: '{nuevoUsuario.Password}'");
            Console.WriteLine($"📱 Teléfono: '{nuevoUsuario.telefono}'");

            var resultado = await UsuarioService.CreateUsuarioAsync(nuevoUsuario);
            Console.WriteLine($"📞 Resultado del servicio: {resultado}");

            if (resultado)
            {
                Console.WriteLine($"✅ Usuario creado exitosamente!");
                SuccessMessage = "¡Cuenta creada exitosamente! Tu cuenta ha sido registrada correctamente.";

                await CargarUsuarios();


                nombre = "";
                email = "";
                password = "";
                telefono = "";

                isLoading = false;
                StateHasChanged();


            }
            else
            {
                ErrorMessage = "El email ya está registrado. Por favor usa otro email.";
                Console.WriteLine("❌ Email ya existe en la base de datos o hubo otro error");
                isLoading = false;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al crear la cuenta: {ex.Message}";
            Console.WriteLine($"💥 ERROR en GuardarUsuario: {ex.Message}");
            Console.WriteLine($"📋 StackTrace: {ex.StackTrace}");
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ClearError()
    {
        ErrorMessage = "";
        StateHasChanged();
    }

    private void ClearSuccess()
    {
        SuccessMessage = "";
        StateHasChanged();
    }
}